<!DOCTYPE html><html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Batch Management System</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e67e22;
            --light-color: #ecf0f1;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --pending-color: #f39c12;
            --running-color: #3498db;
            --completed-color: #27ae60;
            --scheduled-color: #9b59b6;
        }
        * { padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html,body { height:100%; }
        body { background:#f5f5f5; min-height:100vh; }/* Login Styles */
    .login-container {display:flex;justify-content:center;align-items:center;height:100vh;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));}
    .login-form {background:#fff;padding:2rem;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.12);width:400px;}
    .login-form h2 {text-align:center;font-size:1.5rem;color:var(--primary-color);margin-bottom:1rem}
    .form-group {margin-bottom:1rem}
    .form-group label {display:block;margin-bottom:.5rem;font-weight:500;color:#333;}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:6px;font-size:1rem;background:#fff}
    .btn{padding:.75rem 1.25rem;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
    .btn-primary{background:var(--secondary-color);color:#fff;width:100%;}
    .btn-primary:hover{background:#2b82c9;}
    .sync-status{font-size:.85rem;color:#fff;margin-top:.75rem;text-align:center;}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:8px;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* App Layout */
    .app-container{display:none;height:100vh;grid-template-columns:1fr 320px;grid-template-rows:64px 1fr;grid-template-areas:"header sidebar" "main sidebar";}
    .header{grid-area:header;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 1rem;box-shadow:0 2px 6px rgba(0,0,0,.12);}
    .header-left{display:flex;align-items:center;gap:12px;}
    .add-batch-btn{background:var(--accent-color);border:none;color:#fff;width:44px;height:44px;border-radius:50%;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .user-info{display:flex;align-items:center;gap:8px;}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;}
    .user-actions{display:flex;gap:6px;align-items:center;}

    /* Main Content - Chat */
    .main-content{grid-area:main;display:grid;grid-template-rows:1fr;grid-template-areas:"chat";padding:12px}
    .chat-section{grid-area:chat;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.08);display:flex;flex-direction:column;border:1px solid #e0e0e0;height:100%;}
    .chat-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;border-radius:8px 8px 0 0;}
    .chat-messages{flex:1;padding:8px;overflow:auto;display:flex;flex-direction:column;gap:6px;}
    .chat-message{padding:6px 10px;border-radius:8px;max-width:85%;word-wrap:break-word;position:relative;}
    .chat-message.hidden { opacity: 0.5; background: #f0f0f0; }
    .chat-message.system{background:#f0f7ff;align-self:center;max-width:90%;font-style:italic;color:#666;font-size:0.8rem;border:1px solid #d1e3ff;}
    .chat-message.own{background:#e1f5fe;align-self:flex-end;border-bottom-right-radius:4px;border:1px solid #b3e5fc;}
    .chat-message.other{background:#f8f9fa;align-self:flex-start;border-bottom-left-radius:4px;border:1px solid #e9ecef;}
    .chat-message-header{display:flex;justify-content:space-between;font-size:0.7rem;margin-bottom:4px}
    .chat-message-sender{font-weight:600;}
    .chat-message-time{color:#888;}
    .chat-message-content{word-break:break-word;line-height:1.3;font-size:0.95rem;}
    .chat-input-container{display:flex;gap:6px;padding:8px;border-top:1px solid #e0e0e0;background:#f8f9fa;border-radius:0 0 8px 8px;}
    .chat-input{flex:1;padding:8px 12px;border-radius:20px;border:1px solid #ddd;background:#fff;font-size:0.9rem;}
    .chat-send-btn{width:36px;height:36px;border-radius:50%;border:none;background:var(--secondary-color);color:#fff;cursor:pointer;font-weight:bold;font-size:0.9rem;}
    
    .sidebar{grid-area:sidebar;background:#fff;border-left:1px solid #e0e0e0;display:flex;flex-direction:column;}
    .calendar-container{padding:10px;border-bottom:1px solid #e0e0e0;}
    .batch-summary{padding:10px;overflow:auto;flex:1;}
    .summary-item{padding:8px;border-bottom:1px solid #f1f1f1;font-size:0.85rem;display:flex;justify-content:space-between;align-items:center;position:relative;}
    .summary-item.hidden { opacity: 0.5; background: #f8f9fa; }
    .summary-item .status-badge{padding:4px 8px;border-radius:4px;font-size:0.75rem;color:#fff;}
    .summary-item .btn-small{padding:6px 8px;font-size:0.8rem;border-radius:6px;border:none;cursor:pointer}

    /* Toggle Button */
    .toggle-btn { width: 28px; height: 28px; border-radius: 6px; border: none; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: var(--accent-color); color: white; }

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:1000;padding:20px;}
    .modal-content{background:#fff;border-radius:10px;width:540px;max-width:96%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eee;}
    .modal-body{padding:16px;}
    .close-modal{background:none;border:none;font-size:20px;cursor:pointer;}
    .btn-cancel{background:#95a5a6;color:#fff;border:none;padding:.6rem .9rem;border-radius:6px}
    .btn-confirm{background:var(--success-color);color:#fff;border:none;padding:.6rem .9rem;border-radius:6px}

    .admin-config { position: absolute; top: 10px; right: 10px; }
    .tabs { display: flex; border-bottom: 1px solid #ddd; }
    .tab { padding: 10px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: var(--secondary-color); font-weight: 600; color: var(--secondary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .user-list { max-height: 300px; overflow-y: auto; margin-top:8px; border: 1px solid #eee; border-radius: 6px; }
    .user-item { display: flex; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #f1f1f1; align-items: center; }
    .user-item:last-child { border-bottom: none; }

    .calendar-day { padding: 6px; text-align: center; position: relative; cursor: pointer; border-radius: 4px; transition: all 0.2s; font-size: 0.85rem; }
    .calendar-day:hover { background: #f0f0f0; }
    .calendar-day.selected { background: var(--secondary-color); color: white; }
    .calendar-day.has-data::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; }

    /* responsive */
    @media (max-width:900px){ .app-container{grid-template-columns:1fr 260px;} .sidebar{display:none;} }
</style>

</head>
<body><!-- Admin Config Button --><div class="admin-config">
    <button class="btn-small" id="adminConfigBtn" style="display:none; background: var(--accent-color); color: white;">Admin</button>
</div><div class="login-container" id="loginScreen">
    <div class="login-form">
        <h2>Batch Management System</h2>
        <div class="form-group">
            <label for="userId">User ID</label>
            <input type="text" id="userId" placeholder="Enter your user ID" autocomplete="username" />
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password" />
        </div>
        <button class="btn btn-primary" id="loginBtn">Login</button>
        <div class="sync-status" id="syncStatus">
            GitHub Storage - Enter credentials to continue <span class="spinner" id="loginSpinner" style="display:none;"></span>
        </div>
        <div id="loginMessage" style="margin-top:10px;color:#e74c3c;text-align:center;"></div>
    </div>
</div><div class="app-container" id="appContainer">
    <div class="header">
        <div class="header-left">
            <button class="add-batch-btn" id="addBatchBtn" aria-label="Add batch">+</button>
            <div class="header-title" style="color:#fff;font-weight:700;">Batch Management</div>
        </div>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userName">User</span>
            <div class="user-actions">
                <button class="btn-small" id="changePassBtn" style="background:#555;color:#fff;">Change Password</button>
                <button class="btn-small" id="logoutBtn" style="background:var(--danger-color);color:#fff;">Logout</button>
            </div>
        </div>
    </div><div class="main-content">
    <div class="chat-section">
        <div class="chat-header">
            <h3 style="font-size:1rem;margin:0;" id="chatHeader">Team Chat</h3>
            <small id="onlineCount">0 users online</small>
        </div>
        <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." />
            <button class="chat-send-btn" id="chatSendBtn" aria-label="Send">‚û§</button>
        </div>
    </div>
</div>

<div class="sidebar">
    <div class="calendar-container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <button id="prevMonth" class="btn-small">Prev</button>
            <h3 id="currentMonth" style="margin:0;font-size:1rem;">Month Year</h3>
            <button id="nextMonth" class="btn-small">Next</button>
        </div>
        <div id="calendarDays" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;"></div>
    </div>

    <div class="batch-summary" id="batchSummary">
        <h3 style="margin:0 0 8px 0;font-size:1rem;" id="summaryTitle">Today's Batches</h3>
        <div id="todayBatches"></div>
    </div>
</div>

</div><!-- Add Batch Modal --><div class="modal" id="addBatchModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Batch</h3>
            <button class="close-modal" data-close aria-label="Close">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="productName">Product Name</label>
                <select id="productName">
                    <option value="Product A">Product A</option>
                    <option value="Product B">Product B</option>
                    <option value="Product C">Product C</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group" id="otherProductGroup" style="display:none;">
                <label for="otherProduct">Specify Product</label>
                <input id="otherProduct" type="text" placeholder="Product name" />
            </div>
            <div class="form-group">
                <label for="batchNumber">Batch Number</label>
                <input id="batchNumber" type="text" placeholder="Batch number" />
            </div>
            <div class="form-group">
                <label for="comments">Comments</label>
                <textarea id="comments" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="scheduleShift">Schedule Shift</label>
                <select id="scheduleShift">
                    <option value="">Not Scheduled</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                    <option value="C">Shift C</option>
                </select>
            </div>
            <div class="form-group" id="scheduleDateGroup" style="display:none;">
                <label for="scheduleDate">Schedule Date</label>
                <input id="scheduleDate" type="date" />
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="postBatchBtn">Post Batch</button>
            </div>
        </div>
    </div>
</div><!-- Status Update Modal --><div class="modal" id="statusUpdateModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Batch Status</h3>
            <button class="close-modal" data-close aria-label="Close">√ó</button>
        </div>
        <div class="modal-body">
            <div style="display:flex;flex-direction:column;gap:8px;">
                <label><input type="radio" name="status" value="pending"> Pending</label>
                <label><input type="radio" name="status" value="running"> Running</label>
                <label><input type="radio" name="status" value="completed"> Completed</label>
                <label><input type="radio" name="status" value="scheduled"> Scheduled</label>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="updateStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div><!-- Change Password Modal --><div class="modal" id="changePassModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Change Password</h3>
            <button class="close-modal" data-close aria-label="Close">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="oldPass">Current Password</label>
                <input type="password" id="oldPass" />
            </div>
            <div class="form-group">
                <label for="newPass">New Password</label>
                <input type="password" id="newPass" />
            </div>
            <div class="form-group">
                <label for="confirmPass">Confirm New Password</label>
                <input type="password" id="confirmPass" />
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="savePassBtn">Save</button>
            </div>
        </div>
    </div>
</div><!-- Admin Product Names Modal --><div class="modal" id="productNamesModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Product Names</h3>
            <button class="close-modal" data-close aria-label="Close">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="productA">Product A ‚Üí</label>
                <input type="text" id="productA" placeholder="e.g. Paracetamol 500mg" />
            </div>
            <div class="form-group">
                <label for="productB">Product B ‚Üí</label>
                <input type="text" id="productB" placeholder="e.g. Amoxicillin 250mg" />
            </div>
            <div class="form-group">
                <label for="productC">Product C ‚Üí</label>
                <input type="text" id="productC" placeholder="e.g. Vitamin C 1000mg" />
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="saveProductNamesBtn">Save Names</button>
            </div>
        </div>
    </div>
</div><!-- Admin Config Modal --><div class="modal" id="adminConfigModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Admin Panel</h3>
            <button class="close-modal" data-close aria-label="Close">√ó</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <div class="tab active" data-tab="github">GitHub Config</div>
                <div class="tab" data-tab="users">User Management</div>
                <div class="tab" data-tab="products">Product Names</div>
            </div><div class="tab-content active" id="github-tab">
            <div class="form-group">
                <label for="configRepoOwner">GitHub Username</label>
                <input type="text" id="configRepoOwner" placeholder="Your GitHub username" />
            </div>
            <div class="form-group">
                <label for="configRepoName">Repository Name</label>
                <input type="text" id="configRepoName" placeholder="batch-management-data" value="batch-management-data" />
            </div>
            <div class="form-group">
                <label for="configGithubToken">GitHub Token</label>
                <input type="password" id="configGithubToken" placeholder="Paste your GitHub token here" />
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="saveConfigBtn">Save Configuration</button>
            </div>
        </div>
        
        <div class="tab-content" id="users-tab">
            <div class="form-group">
                <h4>Add New User</h4>
                <div style="display:flex;gap:10px;margin-top:8px;">
                    <input type="text" id="newUserId" placeholder="User ID" style="flex:1;" />
                    <input type="text" id="newUserName" placeholder="Full Name" style="flex:1;" />
                    <input type="password" id="newUserPassword" placeholder="Password" style="flex:1;" />
                </div>
                <button class="btn btn-primary" id="addUserBtn" style="width:100%;margin-top:8px;">Add User</button>
            </div>
            <h4 style="margin-top:12px;">Existing Users</h4>
            <div class="user-list" id="userList"></div>
        </div>

        <div class="tab-content" id="products-tab">
            <p>Update generic product names (A, B, C) to real names:</p>
            <button class="btn btn-primary" id="editProductNamesBtn" style="width:100%;margin-top:8px;">Edit Product Names</button>
        </div>
    </div>
</div>

</div><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script>
// ==================== CONFIG & DEFAULTS ====================
const GITHUB_API = 'https://api.github.com';
const DATA_FILE = 'batch-data.json';

let githubConfig = {
    owner: 'NIR-8',
    repo: 'bms',
    token: '' // removed hard-coded token for security ‚Äî set via Admin panel
};

const defaultData = {
    users: [
        { id: 'admin', name: 'Admin User', password: 'password123' },
        { id: 'user1', name: 'User One', password: 'pass123' },
        { id: 'operator', name: 'Operator', password: 'operator123' }
    ],
    batches: [],
    messages: [{ id: '1', sender: 'System', content: 'Welcome!', timestamp: new Date().toISOString() }],
    hiddenItems: { batches: [], messages: [] },
    productNames: { 'Product A': 'Product A', 'Product B': 'Product B', 'Product C': 'Product C' }
};

let calendarState = { currentDate: new Date(), selectedDate: new Date(), viewMode: 'daily' };

// ==================== GITHUB API ====================
async function githubApiRequest(url, options = {}) {
    const headers = Object.assign({
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
    }, options.headers || {});
    if (githubConfig.token) headers['Authorization'] = `token ${githubConfig.token}`;
    try {
        const response = await fetch(`${GITHUB_API}${url}`, { headers, ...options });
        if (!response.ok) {
            const text = await response.text().catch(() => '');
            const err = new Error(`GitHub API error: ${response.status} ${response.statusText} ${text}`);
            err.status = response.status;
            throw err;
        }
        return await response.json();
    } catch (error) {
        console.error('GitHub API request failed:', error);
        throw error;
    }
}

async function readFromGitHub() {
    try {
        const fileData = await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`);
        const content = atob(fileData.content.replace(/\n/g, ''));
        return JSON.parse(content);
    } catch (error) {
        if (error.status === 404 || (error.message && error.message.includes('404'))) {
            // first time: create file
            await saveToGitHub(defaultData);
            return defaultData;
        }
        throw error;
    }
}

async function saveToGitHub(data) {
    try {
        let sha = null;
        try {
            const existingFile = await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`);
            sha = existingFile.sha;
        } catch (e) { sha = null; }

        // safe base64 encoding for unicode
        const json = JSON.stringify(data, null, 2);
        const content = btoa(unescape(encodeURIComponent(json)));
        await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`, {
            method: 'PUT',
            body: JSON.stringify({ message: `Update - ${new Date().toISOString()}`, content, sha })
        });
        return true;
    } catch (error) {
        console.error('Save failed:', error);
        return false;
    }
}

// ==================== APP STATE ====================
let currentUser = null;
let appData = { batches: [], messages: [], users: [], hiddenItems: { batches: [], messages: [] }, productNames: {} };

function formatDate(d) { const dd = new Date(d); return `${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,'0')}-${String(dd.getDate()).padStart(2,'0')}`; }
function formatTime(d) { const dd = new Date(d); return `${String(dd.getHours()).padStart(2,'0')}:${String(dd.getMinutes()).padStart(2,'0')}`; }
function escapeHtml(str) { return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

// Load & Save
async function loadData() {
    try {
        appData = await readFromGitHub();
        if (!appData.productNames) appData.productNames = defaultData.productNames;
        if (!appData.hiddenItems) appData.hiddenItems = { batches: [], messages: [] };
        return true;
    } catch (error) {
        alert('Load failed: ' + (error.message || error));
        return false;
    }
}

async function saveData() {
    try { await saveToGitHub(appData); return true; }
    catch (error) { alert('Save failed: ' + (error.message || error)); return false; }
}

// ==================== LOGIN & LOGOUT ====================
document.getElementById('loginBtn').addEventListener('click', async () => {
    const uid = document.getElementById('userId').value.trim();
    const pwd = document.getElementById('password').value.trim();
    if (!uid || !pwd) return alert('Fill both fields');

    const ok = await loadData();
    if (!ok) return;
    const user = appData.users.find(u => u.id === uid && u.password === pwd);
    if (user) {
        currentUser = user;
        document.getElementById('userAvatar').textContent = (user.name?.[0] || uid[0]).toUpperCase();
        document.getElementById('userName').textContent = user.name || uid;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'grid';

        if (user.id === 'admin') {
            document.getElementById('adminConfigBtn').style.display = 'block';
        }
        renderAll();
    } else {
        alert('Invalid credentials');
    }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
    if (confirm('Logout?')) {
        currentUser = null;
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('userId').value = '';
        document.getElementById('password').value = '';
    }
});

// ==================== CHANGE PASSWORD ====================
document.getElementById('changePassBtn').addEventListener('click', () => {
    document.getElementById('changePassModal').style.display = 'flex';
    document.getElementById('oldPass').value = '';
    document.getElementById('newPass').value = '';
    document.getElementById('confirmPass').value = '';
});

document.getElementById('savePassBtn').addEventListener('click', async () => {
    const oldP = document.getElementById('oldPass').value;
    const newP = document.getElementById('newPass').value;
    const confP = document.getElementById('confirmPass').value;

    if (!oldP || !newP || !confP) return alert('Fill all fields');
    if (newP !== confP) return alert('New passwords do not match');
    if (currentUser.password !== oldP) return alert('Current password incorrect');

    currentUser.password = newP;
    if (await saveData()) {
        alert('Password changed!');
        document.getElementById('changePassModal').style.display = 'none';
    }
});

// ==================== RENDERING ====================
function renderAll() { renderChat(); renderCalendar(); renderToday(); updateOnlineCount(); }

function renderChat() {
    const area = document.getElementById('chatMessages'); area.innerHTML = '';
    const dateStr = formatDate(calendarState.selectedDate);
    const filtered = appData.messages.filter(m => 
        calendarState.viewMode === 'daily' ? formatDate(new Date(m.timestamp)) === dateStr : true
    ).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

    filtered.forEach(msg => {
        const isHidden = appData.hiddenItems.messages.includes(msg.id);
        const isAdmin = currentUser?.id === 'admin';
        const el = document.createElement('div');
        const isOwn = msg.sender === (currentUser.name || currentUser.id);
        el.className = `chat-message ${msg.sender === 'System' ? 'system' : isOwn ? 'own' : 'other'} ${isHidden ? 'hidden' : ''}`;
        el.innerHTML = `
            ${isAdmin ? `<button class="toggle-btn" onclick="toggleVisibility('message', '${msg.id}')">üëÅ</button>` : ''}
            <div class="chat-message-header">
                <span class="chat-message-sender">${escapeHtml(msg.sender)}</span>
                <span class="chat-message-time">${formatTime(new Date(msg.timestamp))}</span>
            </div>
            <div class="chat-message-content">${escapeHtml(msg.content)}</div>`;
        area.appendChild(el);
    });
    area.scrollTop = area.scrollHeight;
}

async function toggleVisibility(type, id) {
    const key = type === 'message' ? 'messages' : 'batches';
    const list = appData.hiddenItems[key];
    const idx = list.indexOf(id);
    if (idx > -1) list.splice(idx, 1); else list.push(id);
    await saveData();
    renderAll();
}

function updateOnlineCount() {
    const fiveMinsAgo = Date.now() - 5*60*1000;
    const users = new Set();
    appData.batches.forEach(b => { if (new Date(b.createdAt).getTime() > fiveMinsAgo) users.add(b.author); });
    appData.messages.forEach(m => { if (new Date(m.timestamp).getTime() > fiveMinsAgo && m.sender !== 'System') users.add(m.sender); });
    document.getElementById('onlineCount').textContent = `${users.size} online`;
}

function renderCalendar() {
    const current = calendarState.currentDate;
    const month = current.getMonth(), year = current.getFullYear();
    document.getElementById('currentMonth').textContent = `${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][month]} ${year}`;
    const days = document.getElementById('calendarDays'); days.innerHTML = '';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => { const h = document.createElement('div'); h.style.fontWeight='700'; h.textContent=d; days.appendChild(h); });

    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();
    for (let i=0; i<firstDay; i++) days.appendChild(document.createElement('div'));
    for (let day=1; day<=totalDays; day++) {
        const cell = document.createElement('div'); cell.className='calendar-day'; cell.textContent=day;
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dateObj = new Date(year, month, day);
        if (appData.batches.some(b => formatDate(new Date(b.createdAt)) === dateStr) || 
            appData.messages.some(m => formatDate(new Date(m.timestamp)) === dateStr)) {
            cell.classList.add('has-data');
        }
        if (formatDate(dateObj) === formatDate(calendarState.selectedDate)) cell.classList.add('selected');
        cell.addEventListener('click', () => { calendarState.selectedDate = dateObj; calendarState.viewMode='daily'; renderAll(); });
        days.appendChild(cell);
    }
}

function renderToday() {
    const container = document.getElementById('todayBatches');
    const dateStr = formatDate(calendarState.selectedDate);
    const batches = calendarState.viewMode === 'daily' 
        ? appData.batches.filter(b => formatDate(new Date(b.createdAt)) === dateStr)
        : appData.batches;

    container.innerHTML = batches.length ? '' : '<div class="summary-item">No batches</div>';

    batches.forEach(b => {
        const isHidden = appData.hiddenItems.batches.includes(b.id);
        const realName = appData.productNames[b.product] || b.product;
        const statusColor = { pending: '#f39c12', running: '#3498db', completed: '#27ae60', scheduled: '#9b59b6' }[b.status] || '#999';

        const div = document.createElement('div');
        div.className = `summary-item ${isHidden ? 'hidden' : ''}`;
        div.innerHTML = `
            <div>
                <strong>${escapeHtml(realName)}</strong> ‚Äì ${escapeHtml(b.batchNumber)}<br>
                <span class="status-badge" style="background:${statusColor};">${escapeHtml(b.status || 'pending')}</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
                ${currentUser?.id === 'admin' ? `<button class="toggle-btn" onclick="toggleVisibility('batch', '${b.id}')">üëÅ</button>` : ''}
                <button class="btn-small" style="background:var(--secondary-color);color:#fff;" 
                        onclick="openStatusModal('${b.id}', '${b.status || 'pending'}')">
                    Update
                </button>
            </div>`;
        container.appendChild(div);
    });
}

// Status Modal
let currentBatchId = null;
function openStatusModal(id, status) {
    currentBatchId = id;
    document.querySelectorAll('input[name="status"]').forEach(r => r.checked = r.value === status);
    document.getElementById('statusUpdateModal').style.display = 'flex';
}

document.getElementById('updateStatusBtn').addEventListener('click', async () => {
    const status = document.querySelector('input[name="status']:checked')?.value || document.querySelector('input[name="status"]:checked')?.value;
    if (!status) return alert('Select status');
    const batch = appData.batches.find(b => b.id === currentBatchId);
    if (batch) {
        batch.status = status;
        batch.logs = batch.logs || [];
        batch.logs.push({ user: currentUser.name || currentUser.id, action: `status ‚Üí ${status}`, timestamp: new Date().toISOString() });
        if (await saveData()) {
            document.getElementById('statusUpdateModal').style.display = 'none';
            renderToday();
        }
    }
});

// Product Names Modal
document.getElementById('editProductNamesBtn').addEventListener('click', () => {
    document.getElementById('productA').value = appData.productNames['Product A'] || '';
    document.getElementById('productB').value = appData.productNames['Product B'] || '';
    document.getElementById('productC').value = appData.productNames['Product C'] || '';
    document.getElementById('productNamesModal').style.display = 'flex';
});

document.getElementById('saveProductNamesBtn').addEventListener('click', async () => {
    appData.productNames['Product A'] = document.getElementById('productA').value.trim() || 'Product A';
    appData.productNames['Product B'] = document.getElementById('productB').value.trim() || 'Product B';
    appData.productNames['Product C'] = document.getElementById('productC').value.trim() || 'Product C';
    if (await saveData()) {
        alert('Product names updated!');
        document.getElementById('productNamesModal').style.display = 'none';
        renderAll();
    }
});

// ==================== BATCH POSTING ====================
document.getElementById('addBatchBtn').addEventListener('click', () => {
    document.getElementById('addBatchModal').style.display = 'flex';
    document.getElementById('batchNumber').value = '';
    document.getElementById('comments').value = '';
    document.getElementById('scheduleShift').value = '';
    document.getElementById('scheduleDateGroup').style.display = 'none';
    document.getElementById('otherProductGroup').style.display = 'none';
});

document.getElementById('productName').addEventListener('change', e => {
    document.getElementById('otherProductGroup').style.display = e.target.value === 'other' ? 'block' : 'none';
});

document.getElementById('scheduleShift').addEventListener('change', e => {
    const g = document.getElementById('scheduleDateGroup');
    if (e.target.value) {
        g.style.display = 'block';
        const today = new Date();
        document.getElementById('scheduleDate').min = formatDate(today);
        document.getElementById('scheduleDate').value = formatDate(today);
    } else g.style.display = 'none';
});

document.getElementById('postBatchBtn').addEventListener('click', async () => {
    const productKey = document.getElementById('productName').value;
    const product = productKey === 'other' 
        ? document.getElementById('otherProduct').value.trim() 
        : appData.productNames[productKey] || productKey;
    const batchNumber = document.getElementById('batchNumber').value.trim();
    const comments = document.getElementById('comments').value.trim();
    const shift = document.getElementById('scheduleShift').value;
    const date = document.getElementById('scheduleDate').value;

    if (!product || !batchNumber || !comments) return alert('Fill all required fields');

    const newBatch = {
        id: Date.now().toString(),
        product: productKey === 'other' ? product : productKey,
        displayName: product,
        batchNumber, comments,
        status: shift ? 'scheduled' : 'pending',
        author: currentUser.name || currentUser.id,
        createdAt: new Date().toISOString(),
        scheduleShift: shift, scheduleDate: date,
        logs: [{ user: currentUser.name || currentUser.id, action: 'created', timestamp: new Date().toISOString() }]
    };

    appData.batches.unshift(newBatch);
    if (await saveData()) {
        document.getElementById('addBatchModal').style.display = 'none';
        renderAll();
    }
});

// ==================== CHAT SEND ====================
document.getElementById('chatSendBtn').addEventListener('click', sendMessage);
document.getElementById('chatInput').addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    appData.messages.push({ id: Date.now().toString(), sender: currentUser.name || currentUser.id, content: text, timestamp: new Date().toISOString() });
    input.value = '';
    if (await saveData()) { renderChat(); }
}

// ==================== ADMIN PANEL ====================
document.getElementById('adminConfigBtn').addEventListener('click', () => {
    document.getElementById('configRepoOwner').value = githubConfig.owner;
    document.getElementById('configRepoName').value = githubConfig.repo;
    document.getElementById('configGithubToken').value = githubConfig.token;
    document.getElementById('adminConfigModal').style.display = 'flex';
    renderUserList();
});

document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab + '-tab').classList.add('active');
}));

document.getElementById('saveConfigBtn').addEventListener('click', () => {
    githubConfig.owner = document.getElementById('configRepoOwner').value.trim();
    githubConfig.repo = document.getElementById('configRepoName').value.trim();
    githubConfig.token = document.getElementById('configGithubToken').value.trim();
    if (githubConfig.owner && githubConfig.repo && githubConfig.token) {
        alert('Config saved!');
        document.getElementById('adminConfigModal').style.display = 'none';
    } else alert('Fill all fields');
});

document.getElementById('addUserBtn').addEventListener('click', async () => {
    const id = document.getElementById('newUserId').value.trim();
    const name = document.getElementById('newUserName').value.trim();
    const pass = document.getElementById('newUserPassword').value.trim();
    if (!id || !name || !pass) return alert('Fill all');
    if (appData.users.some(u => u.id === id)) return alert('User exists');
    appData.users.push({ id, name, password: pass });
    if (await saveData()) { renderUserList(); document.getElementById('newUserId').value = document.getElementById('newUserName').value = document.getElementById('newUserPassword').value = ''; }
});

function renderUserList() {
    const list = document.getElementById('userList'); list.innerHTML = '';
    appData.users.forEach(u => {
        const item = document.createElement('div'); item.className = 'user-item';
        item.innerHTML = `<div><strong>${escapeHtml(u.id)}</strong> - ${escapeHtml(u.name)}</div>
            <div class="user-actions">${u.id !== 'admin' ? `<button class="btn-small btn-delete" data-id="${escapeHtml(u.id)}">Delete</button>` : ''}</div>`;
        list.appendChild(item);
    });
    list.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', async (ev) => {
        const id = ev.currentTarget.dataset.id;
        if (confirm('Delete user?')) {
            appData.users = appData.users.filter(x => x.id !== id);
            await saveData(); renderUserList();
        }
    }));
}

// ==================== MODAL CLOSE & NAV ====================
document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', () => b.closest('.modal').style.display = 'none'));
window.addEventListener('click', e => e.target.classList && e.target.classList.contains('modal') && (e.target.style.display = 'none'));

document.getElementById('prevMonth').addEventListener('click', () => { calendarState.currentDate.setMonth(calendarState.currentDate.getMonth()-1); renderCalendar(); });
document.getElementById('nextMonth').addEventListener('click', () => { calendarState.currentDate.setMonth(calendarState.currentDate.getMonth()+1); renderCalendar(); });

// Auto-refresh (only when a user is logged in)
setInterval(() => currentUser && loadData().then(renderAll).catch(err => console.warn(err)), 30000);

// Initial lightweight setup: show login screen
</script></body>
</html>