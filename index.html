<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Batch Management System</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e67e22;
            --light-color: #ecf0f1;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --pending-color: #f39c12;
            --running-color: #3498db;
            --completed-color: #27ae60;
            --scheduled-color: #9b59b6;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background:#f5f5f5; height:100vh; overflow:hidden; }

        /* Login Styles */
        .login-container {display:flex;justify-content:center;align-items:center;height:100vh;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));}
        .login-form {background:#fff;padding:2rem;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.2);width:400px;}
        .login-form h2 {text-align:center;margin-bottom:1.5rem;color:var(--primary-color);}
        .form-group {margin-bottom:1rem;}
        .form-group label {display:block;margin-bottom:.5rem;font-weight:500;color:#333;}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:6px;font-size:1rem;}
        .btn{padding:.75rem 1.25rem;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
        .btn-primary{background:var(--secondary-color);color:#fff;width:100%;}
        .btn-primary:hover{background:#2b82c9;}
        .sync-status{font-size:.85rem;color:#fff;margin-top:.75rem;text-align:center;}
        .spinner{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:8px;}
        @keyframes spin{to{transform:rotate(360deg);}}

        /* App Layout */
        .app-container{display:none;height:100vh;grid-template-columns:1fr 320px;grid-template-rows:64px 1fr 220px;grid-template-areas:"header sidebar" "main sidebar" "chat sidebar";}
        .header{grid-area:header;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 1rem;box-shadow:0 2px 6px rgba(0,0,0,.12);}
        .header-left{display:flex;align-items:center;gap:12px;}
        .add-batch-btn{background:var(--accent-color);border:none;color:#fff;width:44px;height:44px;border-radius:50%;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
        .user-info{display:flex;align-items:center;gap:8px;}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;}
        .main-content{grid-area:main;padding:1rem;overflow:auto;}
        .batch-list{display:flex;flex-direction:column;gap:12px;}
        .batch-item{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.06);}
        .batch-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
        .batch-product{font-weight:700;color:var(--primary-color);}
        .batch-status{display:flex;align-items:center;gap:8px;}
        .status-indicator{width:12px;height:12px;border-radius:50%;}
        .status-pending{background:var(--pending-color);}
        .status-running{background:var(--running-color);}
        .status-completed{background:var(--completed-color);}
        .status-scheduled{background:var(--scheduled-color);}
        .batch-details{color:#555;margin-bottom:6px;}
        .batch-author{font-size:.85rem;color:#777;margin-bottom:6px;}
        .batch-actions{display:flex;gap:8px;}
        .btn-small{padding:6px 10px;font-size:.9rem;border-radius:6px;border:none;cursor:pointer;}
        .btn-edit{background:var(--secondary-color);color:#fff;}
        .btn-delete{background:var(--danger-color);color:#fff;}
        .btn-status{background:var(--accent-color);color:#fff;}
        .chat-section{grid-area:chat;background:#fff;border-top:1px solid #eee;display:flex;flex-direction:column;}
        .chat-messages{flex:1;padding:10px;overflow:auto;}
        .chat-message{margin-bottom:8px;padding:8px;border-radius:8px;background:#f8f9fa;}
        .chat-input-container{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;}
        .chat-input{flex:1;padding:10px;border-radius:24px;border:1px solid #ddd;}
        .chat-send-btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--secondary-color);color:#fff;cursor:pointer;}
        .sidebar{grid-area:sidebar;background:#fff;border-left:1px solid #eee;display:flex;flex-direction:column;}
        .calendar-container{padding:10px;border-bottom:1px solid #eee;}
        .batch-summary{padding:10px;overflow:auto;flex:1;}
        .summary-item{padding:8px;border-bottom:1px solid #f1f1f1;}

        /* Modal */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:1000;}
        .modal-content{background:#fff;border-radius:10px;width:540px;max-width:96%;box-shadow:0 10px 30px rgba(0,0,0,.2);}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eee;}
        .modal-body{padding:16px;}
        .close-modal{background:none;border:none;font-size:20px;cursor:pointer;}
        .btn-cancel{background:#95a5a6;color:#fff;border:none;}
        .btn-confirm{background:var(--success-color);color:#fff;border:none;}

        .batch-log {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #666;
        }
        
        .admin-config {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>

<!-- Admin Config Button (Hidden by default) -->
<div class="admin-config">
    <button class="btn-small" id="adminConfigBtn" style="display:none; background: var(--accent-color); color: white;">⚙️ Config</button>
</div>

<div class="login-container" id="loginScreen">
    <div class="login-form">
        <h2>Batch Management System</h2>

        <div class="form-group">
            <label for="userId">User ID</label>
            <input type="text" id="userId" placeholder="Enter your user ID" />
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password" />
        </div>

        <button class="btn btn-primary" id="loginBtn">Login</button>

        <div class="sync-status" id="syncStatus">
            GitHub Storage - Enter credentials to continue <span class="spinner" id="loginSpinner" style="display:none;"></span>
        </div>

        <div id="loginMessage" style="margin-top:10px;color:#ffe6e6;text-align:center;"></div>
    </div>
</div>

<div class="app-container" id="appContainer">
    <div class="header">
        <div class="header-left">
            <button class="add-batch-btn" id="addBatchBtn">+</button>
            <div class="header-title" style="color:#fff;font-weight:700;">Batch Management</div>
        </div>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userName">User</span>
            <button class="btn-small" id="refreshBtn" style="margin-left:10px; background:var(--success-color); color:white;">Refresh</button>
        </div>
    </div>

    <div class="main-content">
        <div class="batch-list" id="batchList">
            <!-- Batches will appear here -->
        </div>
    </div>

    <div class="chat-section">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." />
            <button class="chat-send-btn" id="chatSendBtn">↑</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="calendar-container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <button id="prevMonth" class="btn-small">◀</button>
                <h3 id="currentMonth" style="margin:0;font-size:1rem;">Month Year</h3>
                <button id="nextMonth" class="btn-small">▶</button>
            </div>
            <div id="calendarDays" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;"></div>
        </div>

        <div class="batch-summary">
            <h3 style="margin-top:0;">Today's Batches</h3>
            <div id="todayBatches"></div>
        </div>
    </div>
</div>

<!-- Add Batch Modal -->
<div class="modal" id="addBatchModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Batch</h3>
            <button class="close-modal" data-close>×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="productName">Product Name</label>
                <select id="productName">
                    <option value="Product A">Product A</option>
                    <option value="Product B">Product B</option>
                    <option value="Product C">Product C</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group" id="otherProductGroup" style="display:none;">
                <label for="otherProduct">Specify Product</label>
                <input id="otherProduct" type="text" placeholder="Product name" />
            </div>
            <div class="form-group">
                <label for="batchNumber">Batch Number</label>
                <input id="batchNumber" type="text" placeholder="Batch number" />
            </div>
            <div class="form-group">
                <label for="comments">Comments</label>
                <textarea id="comments" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="scheduleShift">Schedule Shift</label>
                <select id="scheduleShift">
                    <option value="">Not Scheduled</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                    <option value="C">Shift C</option>
                </select>
            </div>
            <div class="form-group" id="scheduleDateGroup" style="display:none;">
                <label for="scheduleDate">Schedule Date</label>
                <input id="scheduleDate" type="date" />
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="postBatchBtn">Post Batch</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal" id="statusUpdateModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Batch Status</h3>
            <button class="close-modal" data-close>×</button>
        </div>
        <div class="modal-body">
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div class="status-option" data-status="pending"><label><input type="radio" name="status" value="pending"> Pending</label></div>
                <div class="status-option" data-status="running"><label><input type="radio" name="status" value="running"> Running</label></div>
                <div class="status-option" data-status="completed"><label><input type="radio" name="status" value="completed"> Completed</label></div>
                <div class="status-option" data-status="scheduled"><label><input type="radio" name="status" value="scheduled"> Scheduled</label></div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="updateStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Config Modal -->
<div class="modal" id="adminConfigModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">GitHub Configuration</h3>
            <button class="close-modal" data-close>×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="configRepoOwner">GitHub Username</label>
                <input type="text" id="configRepoOwner" placeholder="Your GitHub username" />
            </div>
            <div class="form-group">
                <label for="configRepoName">Repository Name</label>
                <input type="text" id="configRepoName" placeholder="batch-management-data" value="batch-management-data" />
            </div>
            <div class="form-group">
                <label for="configGithubToken">GitHub Token</label>
                <input type="password" id="configGithubToken" placeholder="Paste your GitHub token here" />
                <small style="color:#666; font-size:0.8rem;">Get token from: GitHub Settings → Developer settings → Personal access tokens</small>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button class="btn btn-cancel" data-close>Cancel</button>
                <button class="btn btn-confirm" id="saveConfigBtn">Save Configuration</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== GITHUB STORAGE CONFIG ====================
const GITHUB_API = 'https://api.github.com';
const DATA_FILE = 'batch-data.json';

// ⚙️ CONFIGURE THESE SETTINGS ONCE - THEN USERS WON'T SEE THEM
let githubConfig = {
    owner: 'YOUR_GITHUB_USERNAME',  // ⬅️ CHANGE THIS
    repo: 'batch-management-data',   // ⬅️ CHANGE THIS IF DIFFERENT
    token: 'YOUR_GITHUB_TOKEN_HERE'  // ⬅️ CHANGE THIS
};

// Default users (will be stored in GitHub)
const defaultUsers = [
    { id: 'admin', name: 'Admin User', password: 'password123' },
    { id: 'user1', name: 'User One', password: 'pass123' },
    { id: 'operator', name: 'Operator', password: 'operator123' }
];

// Default data structure
const defaultData = {
    users: defaultUsers,
    batches: [],
    messages: [
        {
            id: '1',
            sender: 'System',
            content: 'Welcome to Batch Management System! Data stored in GitHub.',
            timestamp: new Date().toISOString()
        }
    ]
};

// ==================== GITHUB API FUNCTIONS ====================
async function githubApiRequest(url, options = {}) {
    try {
        const response = await fetch(`${GITHUB_API}${url}`, {
            headers: {
                'Authorization': `token ${githubConfig.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        });

        if (!response.ok) {
            throw new Error(`GitHub API error: ${response.status} - ${response.statusText}`);
        }

        return await response.json();
    } catch (error) {
        console.error('GitHub API request failed:', error);
        throw error;
    }
}

// Read data from GitHub
async function readFromGitHub() {
    try {
        const fileData = await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`);
        const content = atob(fileData.content.replace(/\n/g, ''));
        return JSON.parse(content);
    } catch (error) {
        if (error.message.includes('404')) {
            // File doesn't exist, create it with default data
            console.log('Data file not found, creating with default data...');
            await saveToGitHub(defaultData);
            return defaultData;
        }
        throw error;
    }
}

// Save data to GitHub
async function saveToGitHub(data) {
    try {
        // First, try to get the existing file to get its SHA
        let sha;
        try {
            const existingFile = await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`);
            sha = existingFile.sha;
        } catch (error) {
            // File doesn't exist yet, that's fine
            sha = null;
        }

        // Convert data to base64
        const content = btoa(JSON.stringify(data, null, 2));
        
        const response = await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`, {
            method: 'PUT',
            body: JSON.stringify({
                message: `Update batch data - ${new Date().toISOString()}`,
                content: content,
                sha: sha
            })
        });

        return response;
    } catch (error) {
        console.error('Failed to save to GitHub:', error);
        throw error;
    }
}

// ==================== APPLICATION CODE ====================
const loginScreen = document.getElementById('loginScreen');
const appContainer = document.getElementById('appContainer');
const loginBtn = document.getElementById('loginBtn');
const loginMessage = document.getElementById('loginMessage');
const loginSpinner = document.getElementById('loginSpinner');
const userAvatar = document.getElementById('userAvatar');
const userName = document.getElementById('userName');
const refreshBtn = document.getElementById('refreshBtn');
const adminConfigBtn = document.getElementById('adminConfigBtn');

let currentUser = null;
let appData = { batches: [], messages: [], users: [] };

// Utility functions
function formatDate(d) { 
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; 
}

function formatDateTime(d) { 
    return `${formatDate(d)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; 
}

function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    str = String(str);
    return str.replace(/&/g,'&amp;')
              .replace(/</g,'&lt;')
              .replace(/>/g,'&gt;')
              .replace(/"/g,'&quot;')
              .replace(/'/g,'&#039;');
}

// Load data from GitHub
async function loadData() {
    try {
        loginMessage.textContent = 'Loading data from GitHub...';
        loginSpinner.style.display = 'inline-block';

        appData = await readFromGitHub();
        
        loginMessage.textContent = 'Data loaded successfully!';
        loginSpinner.style.display = 'none';
        return true;
    } catch (error) {
        console.error('Failed to load data:', error);
        loginMessage.textContent = `Failed to load: ${error.message}`;
        loginSpinner.style.display = 'none';
        return false;
    }
}

// Save data to GitHub
async function saveData() {
    try {
        await saveToGitHub(appData);
        return true;
    } catch (error) {
        console.error('Failed to save data:', error);
        alert('Failed to save data to GitHub. Check your GitHub configuration.');
        return false;
    }
}

// Login handler - SIMPLIFIED! Only user ID and password
loginBtn.addEventListener('click', async () => {
    const uid = document.getElementById('userId').value.trim();
    const pwd = document.getElementById('password').value.trim();

    if (!uid || !pwd) {
        loginMessage.textContent = 'Both user ID and password required';
        return;
    }

    loginMessage.textContent = 'Connecting to GitHub...';
    loginSpinner.style.display = 'inline-block';

    try {
        // Test GitHub connection and load data
        await loadData();
        
        // Find user
        const user = appData.users.find(u => u.id === uid && u.password === pwd);
        if (user) {
            currentUser = user;
            userAvatar.textContent = (user.name?.[0] || user.id?.[0] || 'U').toUpperCase();
            userName.textContent = user.name || user.id;

            loginScreen.style.display = 'none';
            appContainer.style.display = 'grid';

            // Show admin config button only for admin user
            if (user.id === 'admin') {
                adminConfigBtn.style.display = 'block';
            }

            renderAll();
        } else {
            loginMessage.textContent = 'Invalid user ID or password';
        }
    } catch (error) {
        loginMessage.textContent = `Login failed: ${error.message}`;
    } finally {
        loginSpinner.style.display = 'none';
    }
});

// Admin configuration
adminConfigBtn.addEventListener('click', () => {
    document.getElementById('configRepoOwner').value = githubConfig.owner;
    document.getElementById('configRepoName').value = githubConfig.repo;
    document.getElementById('configGithubToken').value = githubConfig.token;
    document.getElementById('adminConfigModal').style.display = 'flex';
});

document.getElementById('saveConfigBtn').addEventListener('click', () => {
    githubConfig.owner = document.getElementById('configRepoOwner').value.trim();
    githubConfig.repo = document.getElementById('configRepoName').value.trim();
    githubConfig.token = document.getElementById('configGithubToken').value.trim();
    
    if (githubConfig.owner && githubConfig.repo && githubConfig.token) {
        alert('GitHub configuration saved!');
        document.getElementById('adminConfigModal').style.display = 'none';
    } else {
        alert('Please fill all configuration fields');
    }
});

// [REST OF THE CODE REMAINS EXACTLY THE SAME...]
// Refresh button, auto-refresh, rendering functions, batch management, chat, etc.
// (All the rendering and functionality code from previous version)

// Refresh button
refreshBtn.addEventListener('click', async () => {
    await loadData();
    renderAll();
});

// Auto-refresh every 30 seconds
setInterval(async () => {
    if (currentUser) {
        await loadData();
        renderAll();
    }
}, 30000);

// ==================== RENDERING FUNCTIONS ====================
function renderAll() { 
    renderBatches(); 
    renderChat(); 
    renderCalendar(); 
    renderToday(); 
}

function renderBatches() {
    const list = document.getElementById('batchList');
    list.innerHTML = '';
    
    const sorted = [...appData.batches].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    sorted.forEach(batch => {
        const statusCls = `status-${batch.status || 'pending'}`;
        const item = document.createElement('div');
        item.className = 'batch-item';
        
        const logsHtml = (batch.logs || []).map(log => 
            `<div>${escapeHtml(log.user)} ${escapeHtml(log.action)} – ${formatDateTime(new Date(log.timestamp))}</div>`
        ).join('');

        item.innerHTML = `
            <div class="batch-header">
                <div class="batch-product">${escapeHtml(batch.product)} - ${escapeHtml(batch.batchNumber)}</div>
                <div class="batch-status">
                    <div class="status-indicator ${statusCls}"></div>
                    <div>${(batch.status || 'pending').charAt(0).toUpperCase() + (batch.status || 'pending').slice(1)}</div>
                </div>
            </div>
            <div class="batch-details">${escapeHtml(batch.comments)}</div>
            ${batch.scheduleShift ? `<div class="batch-details">Scheduled: ${escapeHtml(batch.scheduleDate)} (Shift ${escapeHtml(batch.scheduleShift)})</div>` : ''}
            <div class="batch-author">by ${escapeHtml(batch.author)} on ${formatDateTime(new Date(batch.createdAt))}</div>
            <div class="batch-actions">
                <button class="btn-small btn-delete" data-action="delete" data-id="${batch.id}">Delete</button>
                <button class="btn-small btn-status" data-action="status" data-id="${batch.id}">Update Status</button>
            </div>
            <div class="batch-log">${logsHtml}</div>`;
        
        list.appendChild(item);
    });

    list.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const action = btn.dataset.action;
            const batchId = btn.dataset.id;
            const batch = appData.batches.find(b => String(b.id) === String(batchId));

            if (action === 'delete') {
                if (confirm(`Delete batch ${batch.product} - ${batch.batchNumber}?`)) {
                    appData.batches = appData.batches.filter(b => String(b.id) !== String(batchId));
                    const success = await saveData();
                    if (success) {
                        await loadData();
                        renderAll();
                        addSystemMessage(`Batch ${batch.product} - ${batch.batchNumber} deleted by ${currentUser.name}`);
                    }
                }
            } else if (action === 'status') {
                openStatusModal(batchId);
            }
        });
    });
}

function renderChat() {
    const area = document.getElementById('chatMessages');
    area.innerHTML = '';
    
    const sorted = [...appData.messages].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    sorted.forEach(msg => {
        const el = document.createElement('div');
        el.className = 'chat-message';
        el.innerHTML = `
            <strong>${escapeHtml(msg.sender)}</strong> 
            <small style="color:#666;">${formatDateTime(new Date(msg.timestamp))}</small><br>
            ${escapeHtml(msg.content)}`;
        area.appendChild(el);
    });
    
    area.scrollTop = area.scrollHeight;
}

function renderCalendar() {
    const current = new Date();
    const month = current.getMonth();
    const year = current.getFullYear();
    
    document.getElementById('currentMonth').textContent = 
        `${['January','February','March','April','May','June','July','August','September','October','November','December'][month]} ${year}`;

    const daysEl = document.getElementById('calendarDays');
    daysEl.innerHTML = '';
    
    const weekDays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    weekDays.forEach(day => {
        const header = document.createElement('div');
        header.style.fontWeight = '700';
        header.style.textAlign = 'center';
        header.textContent = day;
        daysEl.appendChild(header);
    });

    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
        daysEl.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= totalDays; day++) {
        const cell = document.createElement('div');
        cell.textContent = day;
        cell.style.padding = '6px';
        cell.style.textAlign = 'center';
        cell.style.position = 'relative';
        
        const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        
        const hasBatches = appData.batches.some(batch => {
            const batchDate = formatDate(new Date(batch.createdAt));
            const scheduledDate = batch.scheduleDate;
            return batchDate === dateStr || scheduledDate === dateStr;
        });

        if (hasBatches) {
            const dot = document.createElement('div');
            dot.style.width = '6px';
            dot.style.height = '6px';
            dot.style.borderRadius = '50%';
            dot.style.background = 'var(--accent-color)';
            dot.style.position = 'absolute';
            dot.style.bottom = '4px';
            dot.style.left = '50%';
            dot.style.transform = 'translateX(-50%)';
            cell.appendChild(dot);
        }
        
        if (current.getDate() === day && current.getMonth() === month && current.getFullYear() === year) {
            cell.style.background = '#eef6ff';
        }
        
        daysEl.appendChild(cell);
    }
}

function renderToday() {
    const today = formatDate(new Date());
    const todayBatches = appData.batches.filter(batch => 
        formatDate(new Date(batch.createdAt)) === today || batch.status !== 'completed'
    );
    
    const container = document.getElementById('todayBatches');
    container.innerHTML = '';
    
    if (todayBatches.length === 0) {
        container.innerHTML = '<div class="summary-item">No active batches for today</div>';
        return;
    }
    
    todayBatches.forEach(batch => {
        const div = document.createElement('div');
        div.className = 'summary-item';
        div.innerHTML = `
            <strong>${escapeHtml(batch.product)}</strong> – ${escapeHtml(batch.batchNumber)}<br>
            Status: ${escapeHtml(batch.status || 'pending')}
        `;
        container.appendChild(div);
    });
}

// ==================== BATCH MANAGEMENT ====================
document.getElementById('addBatchBtn').addEventListener('click', () => {
    document.getElementById('addBatchModal').style.display = 'flex';
    document.getElementById('batchNumber').value = '';
    document.getElementById('comments').value = '';
    document.getElementById('scheduleShift').value = '';
    document.getElementById('scheduleDateGroup').style.display = 'none';
});

document.getElementById('productName').addEventListener('change', (e) => {
    document.getElementById('otherProductGroup').style.display = 
        e.target.value === 'other' ? 'block' : 'none';
});

document.getElementById('scheduleShift').addEventListener('change', (e) => {
    const dateGroup = document.getElementById('scheduleDateGroup');
    if (e.target.value) {
        dateGroup.style.display = 'block';
        const today = new Date();
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 3);
        
        const dateInput = document.getElementById('scheduleDate');
        dateInput.min = formatDate(today);
        dateInput.max = formatDate(maxDate);
        dateInput.value = formatDate(today);
    } else {
        dateGroup.style.display = 'none';
    }
});

document.querySelectorAll('[data-close]').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal').style.display = 'none';
    });
});

document.getElementById('postBatchBtn').addEventListener('click', async () => {
    const productSelect = document.getElementById('productName');
    const product = productSelect.value === 'other' 
        ? document.getElementById('otherProduct').value.trim() 
        : productSelect.value;
    
    const batchNumber = document.getElementById('batchNumber').value.trim();
    const comments = document.getElementById('comments').value.trim();
    const scheduleShift = document.getElementById('scheduleShift').value;
    const scheduleDate = document.getElementById('scheduleDate').value;

    if (!product || !batchNumber || !comments) {
        alert('Please fill all required fields: Product, Batch Number, and Comments');
        return;
    }

    const newBatch = {
        id: Date.now().toString(),
        product: product,
        batchNumber: batchNumber,
        comments: comments,
        status: scheduleShift ? 'scheduled' : 'pending',
        author: currentUser.name || currentUser.id,
        createdAt: new Date().toISOString(),
        scheduleShift: scheduleShift || '',
        scheduleDate: scheduleDate || '',
        logs: [
            { 
                user: currentUser.name || currentUser.id, 
                action: 'created', 
                timestamp: new Date().toISOString() 
            }
        ]
    };

    appData.batches.unshift(newBatch);
    const success = await saveData();
    
    if (success) {
        await loadData();
        addSystemMessage(`${currentUser.name} posted new batch: ${product} - ${batchNumber}`);
        document.getElementById('addBatchModal').style.display = 'none';
        renderAll();
    }
});

// ==================== STATUS UPDATE ====================
function openStatusModal(batchId) {
    const batch = appData.batches.find(b => String(b.id) === String(batchId));
    if (!batch) return;
    
    const modal = document.getElementById('statusUpdateModal');
    modal.style.display = 'flex';
    
    document.querySelectorAll('input[name="status"]').forEach(radio => {
        radio.checked = (radio.value === batch.status);
    });
    
    document.getElementById('updateStatusBtn').dataset.batchId = batchId;
}

document.getElementById('updateStatusBtn').addEventListener('click', async () => {
    const batchId = document.getElementById('updateStatusBtn').dataset.batchId;
    const selectedRadio = document.querySelector('input[name="status"]:checked');
    
    if (!selectedRadio) {
        alert('Please select a status');
        return;
    }
    
    const newStatus = selectedRadio.value;
    const batch = appData.batches.find(b => String(b.id) === String(batchId));
    
    if (!batch) return;
    
    const oldStatus = batch.status;
    if (newStatus === oldStatus) {
        document.getElementById('statusUpdateModal').style.display = 'none';
        return;
    }
    
    batch.status = newStatus;
    batch.logs = batch.logs || [];
    batch.logs.push({
        user: currentUser.name || currentUser.id,
        action: `status changed from ${oldStatus} to ${newStatus}`,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveData();
    if (success) {
        await loadData();
        addSystemMessage(`${currentUser.name} updated ${batch.product} - ${batch.batchNumber} status to ${newStatus}`);
        document.getElementById('statusUpdateModal').style.display = 'none';
        renderAll();
    }
});

// ==================== CHAT FUNCTIONALITY ====================
document.getElementById('chatSendBtn').addEventListener('click', sendMessage);
document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

async function sendMessage() {
    const messageText = document.getElementById('chatInput').value.trim();
    if (!messageText) return;
    
    const newMessage = {
        id: Date.now().toString(),
        sender: currentUser.name || currentUser.id,
        content: messageText,
        timestamp: new Date().toISOString()
    };
    
    appData.messages.push(newMessage);
    const success = await saveData();
    
    if (success) {
        await loadData();
        document.getElementById('chatInput').value = '';
        renderChat();
    }
}

// ==================== SYSTEM MESSAGES ====================
async function addSystemMessage(content) {
    const systemMessage = {
        id: Date.now().toString(),
        sender: 'System',
        content: content,
        timestamp: new Date().toISOString()
    };
    
    appData.messages.push(systemMessage);
    await saveData();
    await loadData();
    renderChat();
}

// ==================== CALENDAR NAVIGATION ====================
document.getElementById('prevMonth').addEventListener('click', () => {
    alert('Calendar navigation will be implemented in future version');
});

document.getElementById('nextMonth').addEventListener('click', () => {
    alert('Calendar navigation will be implemented in future version');
});

// Close modals when clicking outside
window.addEventListener('click', (event) => {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
});
</script>
</body>
</html>